{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/defineProperty\";\nimport _slicedToArray from \"@babel/runtime/helpers/slicedToArray\";\nvar _jsxFileName = \"/home/nailtonjunior/rock/gameplay/src/hooks/auth.tsx\";\nimport _regeneratorRuntime from \"@babel/runtime/regenerator\";\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }\n\nimport React, { createContext, useContext, useState, useEffect } from 'react';\nimport * as AuthSession from 'expo-auth-session';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\nvar SCOPE = process && process.env && process.env.SCOPE || undefined;\nvar CLIENT_ID = process && process.env && process.env.CLIENT_ID || undefined;\nvar CDN_IMAGE = process && process.env && process.env.CDN_IMAGE || undefined;\nvar REDIRECT_URI = process && process.env && process.env.REDIRECT_URI || undefined;\nvar RESPONSE_TYPE = process && process.env && process.env.RESPONSE_TYPE || undefined;\nimport { api } from \"../services/api\";\nimport { COLLECTION_USERS } from \"../configs/database\";\nexport var AuthContext = createContext({});\n\nfunction AuthProvider(_ref) {\n  var children = _ref.children;\n\n  var _useState = useState({}),\n      _useState2 = _slicedToArray(_useState, 2),\n      user = _useState2[0],\n      setUser = _useState2[1];\n\n  var _useState3 = useState(false),\n      _useState4 = _slicedToArray(_useState3, 2),\n      loading = _useState4[0],\n      setLoading = _useState4[1];\n\n  function signIn() {\n    var authUrl, _ref2, type, params, userInfo, firstName, userData;\n\n    return _regeneratorRuntime.async(function signIn$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            _context.prev = 0;\n            setLoading(true);\n            authUrl = api.defaults.baseURL + \"/oauth2/authorize?client_id=\" + CLIENT_ID + \"&redirect_uri=\" + REDIRECT_URI + \"&response_type=\" + RESPONSE_TYPE + \"&scope=\" + SCOPE;\n            _context.next = 5;\n            return _regeneratorRuntime.awrap(AuthSession.startAsync({\n              authUrl: authUrl\n            }));\n\n          case 5:\n            _ref2 = _context.sent;\n            type = _ref2.type;\n            params = _ref2.params;\n\n            if (!(type === \"success\" && !params.error)) {\n              _context.next = 19;\n              break;\n            }\n\n            api.defaults.headers.authorization = \"Bearer \" + params.access_token;\n            _context.next = 12;\n            return _regeneratorRuntime.awrap(api.get('/users/@me'));\n\n          case 12:\n            userInfo = _context.sent;\n            firstName = userInfo.data.username.split(' ')[0];\n            userInfo.data.avatar = CDN_IMAGE + \"/avatars/\" + userInfo.data.id + \"/\" + userInfo.data.avatar + \".png\";\n            userData = _objectSpread(_objectSpread({}, userInfo.data), {}, {\n              firstName: firstName,\n              token: params.access_token\n            });\n            _context.next = 18;\n            return _regeneratorRuntime.awrap(AsyncStorage.setItem(COLLECTION_USERS, JSON.stringify(userData)));\n\n          case 18:\n            setUser(userData);\n\n          case 19:\n            _context.next = 24;\n            break;\n\n          case 21:\n            _context.prev = 21;\n            _context.t0 = _context[\"catch\"](0);\n            throw new Error('Não foi possível autenticar');\n\n          case 24:\n            _context.prev = 24;\n            setLoading(false);\n            return _context.finish(24);\n\n          case 27:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, null, null, [[0, 21, 24, 27]], Promise);\n  }\n\n  function signOut() {\n    return _regeneratorRuntime.async(function signOut$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            setUser({});\n            _context2.next = 3;\n            return _regeneratorRuntime.awrap(AsyncStorage.removeItem(COLLECTION_USERS));\n\n          case 3:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  }\n\n  function loadUserStorageData() {\n    var storage, userLogged;\n    return _regeneratorRuntime.async(function loadUserStorageData$(_context3) {\n      while (1) {\n        switch (_context3.prev = _context3.next) {\n          case 0:\n            _context3.next = 2;\n            return _regeneratorRuntime.awrap(AsyncStorage.getItem(COLLECTION_USERS));\n\n          case 2:\n            storage = _context3.sent;\n\n            if (storage) {\n              userLogged = JSON.parse(storage);\n              api.defaults.headers.authorization = \"Bearer \" + userLogged.token;\n              setUser(userLogged);\n            }\n\n          case 4:\n          case \"end\":\n            return _context3.stop();\n        }\n      }\n    }, null, null, null, Promise);\n  }\n\n  useEffect(function () {\n    loadUserStorageData();\n  }, []);\n  return React.createElement(AuthContext.Provider, {\n    value: {\n      user: user,\n      loading: loading,\n      signIn: signIn,\n      signOut: signOut\n    },\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 109,\n      columnNumber: 5\n    }\n  }, children);\n}\n\nfunction useAuth() {\n  var context = useContext(AuthContext);\n  return context;\n}\n\nexport { AuthProvider, useAuth };","map":{"version":3,"sources":["/home/nailtonjunior/rock/gameplay/src/hooks/auth.tsx"],"names":["React","createContext","useContext","useState","useEffect","AuthSession","AsyncStorage","SCOPE","CLIENT_ID","CDN_IMAGE","REDIRECT_URI","RESPONSE_TYPE","api","COLLECTION_USERS","AuthContext","AuthProvider","children","user","setUser","loading","setLoading","signIn","authUrl","defaults","baseURL","startAsync","type","params","error","headers","authorization","access_token","get","userInfo","firstName","data","username","split","avatar","id","userData","token","setItem","JSON","stringify","Error","signOut","removeItem","loadUserStorageData","getItem","storage","userLogged","parse","useAuth","context"],"mappings":"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","sourcesContent":["import React,\n{\n  createContext,\n  useContext,\n  useState,\n  ReactNode,\n  useEffect,\n} from 'react';\n\nimport * as AuthSession from 'expo-auth-session';\nimport AsyncStorage from '@react-native-async-storage/async-storage';\n\nconst { SCOPE } = process.env;\nconst { CLIENT_ID } = process.env;\nconst { CDN_IMAGE } = process.env;\nconst { REDIRECT_URI } = process.env;\nconst { RESPONSE_TYPE } = process.env;\n\nimport { api } from '../services/api';\nimport { COLLECTION_USERS } from '../configs/database';\n\ntype User = {\n  id: string;\n  username: string;\n  firstName: string;\n  avatar: string;\n  email: string;\n  token: string;\n}\n\ntype AuthContextData = {\n  user: User;\n  loading: boolean;\n  signIn: () => Promise<void>;\n  signOut: () => Promise<void>;\n}\n\ntype AuthProviderProps = {\n  children: ReactNode;\n}\n\ntype AuthorizationResponse = AuthSession.AuthSessionResult & {\n  params: {\n    access_token?: string;\n    error?: string;\n  }\n}\n\nexport const AuthContext = createContext({} as AuthContextData);\n\nfunction AuthProvider({ children }: AuthProviderProps) {\n  const [user, setUser] = useState<User>({} as User);\n  const [loading, setLoading] = useState(false);\n\n  async function signIn() {\n    try {\n      setLoading(true);\n\n      const authUrl = `${api.defaults.baseURL}/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=${RESPONSE_TYPE}&scope=${SCOPE}`;\n\n      const { type, params } = await AuthSession\n        .startAsync({ authUrl }) as AuthorizationResponse;\n\n      if (type === \"success\" && !params.error) {\n        api.defaults.headers.authorization = `Bearer ${params.access_token}`;\n\n        const userInfo = await api.get('/users/@me');\n\n        const firstName = userInfo.data.username.split(' ')[0];\n        userInfo.data.avatar = `${CDN_IMAGE}/avatars/${userInfo.data.id}/${userInfo.data.avatar}.png`;\n\n        const userData = {\n          ...userInfo.data,\n          firstName,\n          token: params.access_token\n        }\n\n        await AsyncStorage.setItem(COLLECTION_USERS, JSON.stringify(userData));\n        setUser(userData);\n      }\n    } catch {\n      throw new Error('Não foi possível autenticar');\n    } finally {\n      setLoading(false);\n    }\n  }\n\n  async function signOut() {\n    setUser({} as User);\n    await AsyncStorage.removeItem(COLLECTION_USERS);\n  }\n\n  async function loadUserStorageData() {\n    const storage = await AsyncStorage.getItem(COLLECTION_USERS);\n\n    if (storage) {\n      const userLogged = JSON.parse(storage) as User;\n      api.defaults.headers.authorization = `Bearer ${userLogged.token}`;\n\n      setUser(userLogged);\n    }\n  }\n\n  useEffect(() => {\n    loadUserStorageData();\n  }, []);\n\n  return (\n    <AuthContext.Provider value={{\n      user,\n      loading,\n      signIn,\n      signOut\n    }}>\n      {children}\n    </AuthContext.Provider>\n  )\n}\n\nfunction useAuth() {\n  const context = useContext(AuthContext);\n\n  return context;\n}\n\nexport {\n  AuthProvider,\n  useAuth\n}"]},"metadata":{},"sourceType":"module"}